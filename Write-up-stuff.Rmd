---
title: "Quantifying The Effect of Pitching Metrics"
author: "Max Brown"
date: "May 20, 2022"
output: 
  pdf_document: 
    fig_height: 4
    fig_width: 7
---


## Introduction 
Throughout the establishment of baseball statistics, the perception of pitchers has surrounded around their earned run average and walk rate. Recently, there has been a focus on new techniques, such as using pitcher and pitch specific statistics to determine the most efficient way to evaluate pitchers. In 2015, Mike Sonne created a metric titled "Stuff+" in which he used a pitcher's change in velocity and break distance of off-speed pitches to determine a value relative to other pitchers (https://fantasy.fangraphs.com/using-the-stuff-metric-as-an-injury-identification-tool/). The following year, he used the stuff metric to discover that Marco Estrada recently saw a dip in his rating from his previous starts, releasing an article that the Blue Jays pitcher might be dealing with an injury. Sonne ended up being correct as it was announced that Estrada was suffering from a herniated disc. My report is inspired by Sonne's work, but takes a different approach. Similar to Driveline's December 2021 study of this new "Stuff" metric, this report will focus closer on individual pitches and how they compare within each pitcher and across different pitchers (https://www.drivelinebaseball.com/2021/12/what-is-stuff-quantifying-pitches-with-pitch-models/). However, instead of using a formula of percentiles for different metrics to determine a final value, my methodology will use a results-based approach to determine how certain pitching metrics alter the odds of an ideal result for the pitcher. 

The data used for this analysis was extracted from baseballsavant.mlb.com. It consists of over 70000 pitches throughout the 2022 regular season from Opening Day to July 30th. To narrow the focus of this study, the data set consists of only breaking pitches, with a primary focus on sliders, knuckle curves, and curveballs. These indications are determined based on the "pitch type" in Baseball Savant's data. The main pitching variables are: 

"release_speed" - Speed of baseball once released from the pitcher's hand (mph)
"release_spin_rate" - Spin of the baseball once released from the pitcher's hand (rpm)
"pfx_x" - Horizontal movement of baseball during the duration of the pitch 
"pfx_z" - Vertical movement of baseball during the duration of the pitch 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      warning = F, 
                      message = F)
```


```{r load-packages}
# load packages
library(tidyverse)
library(knitr)
library(lme4)
library(broom.mixed)
library(skimr)
library(readr)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(knitr)
library(lme4)
library(broom.mixed)
library(skimr)
library(readr)
library(ggplot2)
library(dplyr)
```



```{r}
left <- read_csv("left_all_innings.csv")
right <- read_csv("right_all_innings.csv")
```


Statcast and Baseball Savant records pfx_x and pfx_z in feet. To evaluate how the change in each of these variables affects our response, converting to inches is reasonable. Additionally, the data sets do not have a minimum requirement of pitches, meaning that there are most likely position players included. To remove position players and pitchers with very little major league experience throwing breaking balls, a minimum requirement of 30 pitches will be set for analysis. 

```{r inch-switch}
left <- left %>% drop_na(release_speed, release_spin_rate, pfx_x, 
                        pfx_z, spin_axis)
left <- left %>% mutate(hor_break = (pfx_x*12), 
                                      ind_vert_break = (pfx_z*12))

right<- right %>% drop_na(release_speed, release_spin_rate, pfx_x, 
                        pfx_z, spin_axis)
right <- right %>% mutate(hor_break = (pfx_x*12), 
                                      ind_vert_break = (pfx_z*12))
```


```{r pitch-breakup}
all_rows <- rbind(right, left)
keep_names = all_rows %>% group_by(player_name) %>% count() %>% ungroup() %>% 
  filter(n>=30) %>% .$player_name
right <- right %>% filter(player_name %in% keep_names) 
left <- left %>% filter(player_name %in% keep_names) 

```





## General EDA 

```{r expected-batting-average-by-speed/angle}
ggplot(data = subset(right, !is.na(estimated_ba_using_speedangle)), 
       mapping = aes(x=launch_speed, y=launch_angle, 
                     color = estimated_ba_using_speedangle)) + 
  geom_point() + labs(title = "Right-Handed Speed/Angle Breakdown", 
                      x = "Exit Velocity (mph)", 
                      y = "Launch Angle (degrees)", 
                      color = "Estimated Batting Average") 


```



```{r}
ggplot(data = subset(left, !is.na(estimated_ba_using_speedangle)), 
       mapping = aes(x=launch_speed, y=launch_angle, 
                     color = estimated_ba_using_speedangle)) + 
  geom_point() + labs(title = "Left-Handed Speed/Angle Breakdown", 
                      x = "Exit Velocity (mph)", 
                      y = "Launch Angle (degrees)", 
                      color = "Estimated Batting Average") 
```

The graphs above show an almost identical distribution of batted balls between left-handed and right-handed pitchers. It is also worth noting that estimated batting average, a measure utilized by Statcast to approximate the probability of a batted ball resulting in a hit, is heavily affected by both exit velocity and launch angle. 




```{r in play}
all_rows <- all_rows %>% 
  mutate(inplay_out = ifelse(events == c("double_play", "field_out", 
                                         "fielders_choice_out", "force_out", 
                                         "grounded_into_double_play", 
                                         "other_out", "sac_fly",
                                         "sac_fly_double_play"), "1", "0"))

r_in_play_df <- all_rows %>% filter(description == "hit_into_play") %>% filter(release_speed >= 70)

ggplot(data = r_in_play_df, mapping = aes(x=release_speed, y=launch_speed, 
                                color = inplay_out)) + 
  geom_point() + labs(title = "No Relationship For Release Speed 
                      and Launch Speed/Out Made", 
                      x = "Release Speed of Pitch", 
                      y = "Exit Speed of Contact", 
                      color = "Out Recorded") 


```

After filtering out batted balls hit less than 70 mph, it is apparent that there is not a clear relationship between pitch speed, exit velocity, and an out being recorded. This visual shows that the game of baseball can't solely be determined from speed, as television broadcasts often use these statistics to broadly evaluate the quality of a pitch. 


### Righty EDA

```{r rh-groups}

ggplot(data = right, mapping = aes(x=hor_break, y=ind_vert_break, 
                                color = pitch_name)) + 
  geom_point() + labs(title = "Right-Handed Breakdown", 
                      x = "Horizontal Break (in)", 
                      y = "Induced Vertical Break (in)", 
                      color = "Pitch Name") 

```



```{r}
rh_stats <- right %>% group_by(pitch_name) %>% 
  summarize(release_speed = mean(release_speed), 
            release_spin = mean(release_spin_rate),
            hor_break = mean(hor_break), 
            vert_break = mean(ind_vert_break), 
            tilt = mean(spin_axis)) 

kable(rh_stats, caption = "Average RH Pitch Type Metrics", digits = 2)
```


```{r}
r_freq <- right %>% count(pitch_type, pitch_name)
kable(r_freq)
```






### Lefty EDA

```{r lh-groups}
ggplot(data = left, mapping = aes(x=hor_break, y=ind_vert_break, 
                                color = pitch_name)) + 
  geom_point() + labs(title = "Left-Handed Breakdown", 
                      x = "Horizontal Break (in)", 
                      y = "Induced Vertical Break (in)") 
```



```{r}
lh_stats <- left %>% group_by(pitch_type) %>% 
  summarize(release_speed = mean(release_speed), 
            release_spin = mean(release_spin_rate),
            hor_break = mean(hor_break), 
            vert_break = mean(ind_vert_break), 
            tilt = mean(spin_axis)) 

kable(lh_stats, caption = "Average LH Pitch Type Metrics", digits = 2)
```

```{r}
l_freq <- left %>% count(pitch_type, pitch_name)

kable(l_freq)
```

After looking at summary statistics for both right and left handed pitch types, it makes the most sense to proceed for sliders, knuckle-curves, and curveballs. For slow curves (listed as "CS") and eephus pitches, there is not a large enough sample size to provide useful insight. 


## Methodology 


```{r}
inplay_avg_benchmark <- all_rows %>% filter(description == "hit_into_play") %>% 
  drop_na(estimated_ba_using_speedangle) %>%
  summarise(mean_estimated_ba = mean(estimated_ba_using_speedangle))

inplay_avg_benchmark <- inplay_avg_benchmark$mean_estimated_ba
```


```{r}
pitcher_ideal_creation <- function(dataset) {
  dataset <- dataset %>% mutate(pitcher_ideal = if_else(description == "called_strike" | description == "foul"| description == "foul_bunt"| description == "foul_tip"| description == "missed_bunt"| description == "swinging_strike"| description == "swinging_strike_blocked" | estimated_ba_using_speedangle <= inplay_avg_benchmark, 1, 0))
  dataset <- dataset %>% mutate_at(vars("pitcher_ideal"), ~replace_na(.,0))
 return(dataset)
}

right <- pitcher_ideal_creation(right)
left <- pitcher_ideal_creation(left)
```


In creating a response variable I decided to simplify the result of the pitch into an ideal and unideal scenario for the pitcher. Any pitch not put into play and results in a strike is a pitcher ideal result for the pitch. Additionally, any ball put in play with an expected batting average of less than .311, the average estimated batting average for batted balls in the entire dataset, is considered an ideal result. These ideal results are assigned as 1 and all other outcomes are given a 0, creating a binary response variable. Using this response and given the correlation in pitches between pitchers, a multi-level approach is needed with each individual pitch as the first level observational unit and the pitchers as the second level observational unit. To maximize the amount of predictor variables that can be included into the model for each pitch type, a level of significance of .2 will suffice. 

### Creating Right Handed Models 

#### Curveball

```{r}
right_curve <- right %>% filter(pitch_type == "CU")
right_curve <- right_curve %>% group_by(player_name) %>% 
  mutate(mean_centered_spinrate = mean(release_spin_rate) - release_spin_rate) %>% 
  ungroup()

rh_cu_model <- glmer(pitcher_ideal ~ release_speed + hor_break + 
                       ind_vert_break + mean_centered_spinrate + (1|player_name),
                   family = "binomial", data = right_curve)


tidy(rh_cu_model) %>% kable(digits = 4, caption = "Initial RH Curveball Model")
```

```{r}
rh_cu_model_final <- glmer(pitcher_ideal ~
                       hor_break + mean_centered_spinrate + (1|player_name), 
                     family = "binomial", data = right_curve)
tidy(rh_cu_model_final) %>% kable(digits = 4, caption = "Final RH Curveball Model")
```
With induced vertical break and release speed having high p-values exceeding the .2 threshold, we can re-fit the model with horizontal break and mean-centered-spinrate, a variable that evaluates how much the spin rate differs from a player's average spin on that particular pitch. 

```{r}
right_curve <- right_curve %>% 
  mutate(ideal_prob = (exp(.0294 + 0.0138*hor_break + 0.0004*mean_centered_spinrate)
                       / (1+exp(.0294 + 0.0138*hor_break + 0.0004*mean_centered_spinrate))))

right_curve <- right_curve %>% 
  mutate(pitch_rating = 100 * (ideal_prob/mean(ideal_prob)))
```

With the final model for right-handed curves, we can conclude that within this data set the log odds for a pitcher-ideal result increases by 0.0138 for every additional inch in horizontal break, and by 0.0004 for every rpm that exceeds a player's average spin for their right-handed curveballs. We then can create a pitch rating with each curveball centered at 100 which classifies as the average probability for a pitcher-ideal result. 

#### Knuckle-Curve

```{r}
right_knuckle_curve <- right %>% filter(pitch_type == "KC")
right_knuckle_curve <- right_knuckle_curve %>% group_by(player_name) %>% 
  mutate(mean_centered_spinrate = mean(release_spin_rate) - release_spin_rate) %>% 
  ungroup()

rh_kc_model <- glmer(pitcher_ideal ~ release_speed + hor_break + 
                       ind_vert_break + mean_centered_spinrate + (1|player_name),
                   family = "binomial", data = right_knuckle_curve)


tidy(rh_kc_model) %>% kable(digits = 4, caption = "Initial RH Knuckle-Curveball Model")
```

All predictors have p-values above our level of significance so we can't determine conclusive results for right-handed knuckle-curves. 

#### Slider 

```{r}
right_slider <- right %>% filter(pitch_type == "SL")
right_slider <- right_slider %>% group_by(player_name) %>% 
  mutate(mean_centered_spinrate = mean(release_spin_rate) - release_spin_rate) %>% 
  ungroup()

rh_sl_model <- glmer(pitcher_ideal ~ release_speed + hor_break + 
                       ind_vert_break + mean_centered_spinrate + (1|player_name),
                   family = "binomial", data = right_slider)


tidy(rh_sl_model) %>% kable(digits = 4)
```

All predictors except for horizontal break can be refitted for a final right-handed sliders model. 

```{r}
rh_sl_model_final <- glmer(pitcher_ideal ~
                       release_speed + ind_vert_break + mean_centered_spinrate +
                         (1|player_name), 
                     family = "binomial", data = right_slider)
tidy(rh_sl_model_final) %>% kable(digits = 4)
```


```{r}
right_slider <- right_slider %>% 
  mutate(ideal_prob = (exp(1.3766 + -0.0135*release_speed + ind_vert_break*0.0072 
                           + 0.0003*mean_centered_spinrate)
                       / (1+exp(1.3766 + -0.0135*release_speed + ind_vert_break*0.0072 
                           + 0.0003*mean_centered_spinrate))))

right_slider <- right_slider %>% 
  mutate(pitch_rating = 100 * (ideal_prob/mean(ideal_prob)))
```



### Creating Left Handed Models 

#### Curve

```{r}
left_curve <- left %>% filter(pitch_type == "CU")
left_curve <- left_curve %>% group_by(player_name) %>% 
  mutate(mean_centered_spinrate = mean(release_spin_rate) - release_spin_rate) %>% 
  ungroup()

lh_cu_model <- glmer(pitcher_ideal ~ release_speed + hor_break + 
                       ind_vert_break + mean_centered_spinrate + (1|player_name),
                   family = "binomial", data = left_curve)


tidy(lh_cu_model) %>% kable(digits = 4)
```


```{r}
lh_cu_model_final <- glmer(pitcher_ideal ~
                       hor_break + mean_centered_spinrate + (1|player_name), 
                     family = "binomial", data = left_curve)
tidy(lh_cu_model_final) %>% kable(digits = 4)
```


```{r}
left_curve <- left_curve %>% 
  mutate(ideal_prob = (exp(0.1373 + -0.0064*hor_break + 0.0004*mean_centered_spinrate)
                       / (1+exp(0.1373 + -0.0064*hor_break + 0.0004*mean_centered_spinrate))))

left_curve <- left_curve %>% 
  mutate(pitch_rating = 100 * (ideal_prob/mean(ideal_prob)))
```


#### Knuckle-Curve

```{r}
left_knuckle_curve <- left %>% filter(pitch_type == "KC")
left_knuckle_curve <- left_knuckle_curve %>% group_by(player_name) %>% 
  mutate(mean_centered_spinrate = mean(release_spin_rate) - release_spin_rate) %>% 
  ungroup()

lh_kc_model <- glmer(pitcher_ideal ~ release_speed + hor_break + 
                       ind_vert_break + mean_centered_spinrate + (1|player_name),
                   family = "binomial", data = left_knuckle_curve)


tidy(rh_kc_model) %>% kable(digits = 4)
```



#### Slider 

```{r}
left_slider <- left %>% filter(pitch_type == "SL")
left_slider <- left_slider %>% group_by(player_name) %>% 
  mutate(mean_centered_spinrate = mean(release_spin_rate) - release_spin_rate) %>% 
  ungroup()

lh_sl_model <- glmer(pitcher_ideal ~ release_speed + hor_break + 
                       ind_vert_break + mean_centered_spinrate + (1|player_name),
                   family = "binomial", data = left_slider)


tidy(lh_sl_model) %>% kable(digits = 4)
```

```{r}
lh_sl_model_final <- glmer(pitcher_ideal ~
                       hor_break + ind_vert_break + mean_centered_spinrate +
                         (1|player_name), 
                     family = "binomial", data = left_slider)
tidy(lh_sl_model_final) %>% kable(digits = 4)
```


```{r}
left_slider <- left_slider %>% 
  mutate(ideal_prob = (exp(0.1934 + -0.0062*hor_break + ind_vert_break*0.0143 
                           + 0.0002*mean_centered_spinrate)
                       / (1+exp(0.1934 + -0.0062*hor_break + ind_vert_break*0.0143 
                           + 0.0002*mean_centered_spinrate))))

left_slider <- left_slider %>% 
  mutate(pitch_rating = 100 * (ideal_prob/mean(ideal_prob)))
```




```{r}
applicable_models <- rbind(right_curve, right_slider, 
                           left_curve, left_slider)

player_means <- applicable_models %>% group_by(player_name) %>% summarise(mean_rating = mean(pitch_rating), 
                                                                          pitches = n())
arrange(player_means, desc(mean_rating)) %>% head(10) %>% kable(digits = 3, caption = "Top Ten Average Pitch Ratings By Player")
```





## Appendix 

```{r}
right_names = right %>% group_by(player_name) %>%  .$player_name
left_names = left %>% group_by(player_name) %>%  .$player_name
set.seed(3)

# get sample of 12 pitchers
sample_righties <- sample(right_names, 12)
sample_lefties <- sample(left_names, 12)

# get data for those schools
sample_data_r <- right %>%
  filter(player_name %in% sample_righties)

sample_data_l <- left %>% 
  filter(player_name %in% sample_lefties)

ggplot(data = sample_data_r, mapping = aes(x=release_extension, y=release_speed, 
                                color = pitch_name)) + facet_wrap(~player_name) +
  geom_point() + 
  labs(title = "Inconclusive Evidence of Righty Extension/Speed Relationship", 
       x = "Release Extension (Feet)", 
       y = "Release Speed (MPH)")



```


```{r}
ggplot(data = sample_data_l, mapping = aes(x=release_extension, y=release_speed, 
                                color = pitch_name)) + facet_wrap(~player_name) +
  geom_point() + 
  labs(title = "Inconclusive Evidence of 
       Lefty Extension/Speed Relationship", 
       x = "Release Extension (Feet)", 
       y = "Release Speed (MPH)")
```
