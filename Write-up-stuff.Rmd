---
title: "Quantifying The Effect of Pitching Metrics"
author: "Max Brown"
date: "May 20, 2022"
output: 
  pdf_document: 
    fig_height: 4
    fig_width: 7
---


## Introduction 
The methodology of analyzing the performance of pitchers has drastically changed over time. At the surface one can evaluate at pitcher's win-loss record to determine their impact on the teams' performance. It's a results-based model, but includes several factors far out of a pitcher's control, fundamentally the 



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      warning = F, 
                      message = F)
```


```{r load-packages}
# load packages
library(tidyverse)
library(knitr)
library(lme4)
library(broom.mixed)
library(skimr)
library(readr)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(knitr)
library(lme4)
library(broom.mixed)
library(skimr)
library(readr)
library(ggplot2)
library(dplyr)
```



```{r}
left <- read_csv("left_all_innings.csv")
right <- read_csv("right_all_innings.csv")
```




```{r inch-switch}
left <- left %>% drop_na(release_speed, release_spin_rate, pfx_x, 
                        pfx_z, spin_axis)
left <- left %>% mutate(hor_break = (pfx_x*12), 
                                      ind_vert_break = (pfx_z*12))

right<- right %>% drop_na(release_speed, release_spin_rate, pfx_x, 
                        pfx_z, spin_axis)
right <- right %>% mutate(hor_break = (pfx_x*12), 
                                      ind_vert_break = (pfx_z*12))
```


```{r pitch-breakup}
all_rows <- rbind(right, left)
```





## General EDA 

```{r expected-batting-average-by-speed/angle}
ggplot(data = subset(right, !is.na(estimated_ba_using_speedangle)), 
       mapping = aes(x=launch_speed, y=launch_angle, 
                     color = estimated_ba_using_speedangle)) + 
  geom_point() + labs(title = "Right-Handed Speed/Angle Breakdown", 
                      x = "Exit Velocity (mph)", 
                      y = "Launch Angle (degrees)", 
                      color = "Estimated Batting Average") 


```

```{r}
ggplot(data = subset(left, !is.na(estimated_ba_using_speedangle)), 
       mapping = aes(x=launch_speed, y=launch_angle, 
                     color = estimated_ba_using_speedangle)) + 
  geom_point() + labs(title = "Left-Handed Speed/Angle Breakdown", 
                      x = "Exit Velocity (mph)", 
                      y = "Launch Angle (degrees)", 
                      color = "Estimated Batting Average") 
```

```{r}
all_rows <- all_rows %>% 
  mutate(inplay_out = ifelse(events == c("double_play", "field_out", 
                                         "fielders_choice_out", "force_out", 
                                         "grounded_into_double_play", 
                                         "other_out", "sac_fly",
                                         "sac_fly_double_play"), "1", "0"))

r_in_play_df <- all_rows %>% filter(description == "hit_into_play")

ggplot(data = r_in_play_df, mapping = aes(x=release_speed, y=launch_speed, 
                                color = inplay_out)) + 
  geom_point() + labs(title = "No Relationship For Release Speed 
                      and Launch Speed/Out Made", 
                      x = "Release Speed of Pitch", 
                      y = "Exit Speed of Contact", 
                      color = "Out Recorded") 


```



### Righty EDA

```{r rh-groups}

ggplot(data = right, mapping = aes(x=hor_break, y=ind_vert_break, 
                                color = pitch_name)) + 
  geom_point() + labs(title = "Right-Handed Breakdown", 
                      x = "Horizontal Break (in)", 
                      y = "Induced Vertical Break (in)", 
                      color = "Pitch Name") 

```



```{r}
rh_stats <- right %>% group_by(pitch_name) %>% 
  summarize(release_speed = mean(release_speed), 
            release_spin = mean(release_spin_rate),
            hor_break = mean(hor_break), 
            vert_break = mean(ind_vert_break), 
            tilt = mean(spin_axis)) 

kable(rh_stats, caption = "Average RH Pitch Type Metrics", digits = 2)
```


```{r}
r_freq <- right %>% count(pitch_type, pitch_name)
kable(r_freq)
```






### Lefty EDA

```{r lh-groups}
ggplot(data = left, mapping = aes(x=hor_break, y=ind_vert_break, 
                                color = pitch_name)) + 
  geom_point() + labs(title = "Left-Handed Breakdown", 
                      x = "Horizontal Break (in)", 
                      y = "Induced Vertical Break (in)") 
```



```{r}
lh_stats <- left %>% group_by(pitch_type) %>% 
  summarize(release_speed = mean(release_speed), 
            release_spin = mean(release_spin_rate),
            hor_break = mean(hor_break), 
            vert_break = mean(ind_vert_break), 
            tilt = mean(spin_axis)) 

kable(lh_stats, caption = "Average LH Pitch Type Metrics", digits = 2)
```

```{r}
l_freq <- left %>% count(pitch_type, pitch_name)

kable(l_freq)
```




## Methodology 

```{r}
#right <- subset(right, select = -inplay_out )

```


```{r}
inplay_avg_benchmark <- all_rows %>% filter(description == "hit_into_play") %>% 
  drop_na(estimated_ba_using_speedangle) %>%
  summarise(mean_estimated_ba = mean(estimated_ba_using_speedangle))

inplay_avg_benchmark <- inplay_avg_benchmark$mean_estimated_ba
```


```{r}
pitcher_ideal_creation <- function(dataset) {
  dataset <- dataset %>% mutate(pitcher_ideal = if_else(description == "called_strike" | description == "foul"| description == "foul_bunt"| description == "foul_tip"| description == "missed_bunt"| description == "swinging_strike"| description == "swinging_strike_blocked" | estimated_ba_using_speedangle <= inplay_avg_benchmark, 1, 0))
  dataset <- dataset %>% mutate_at(vars("pitcher_ideal"), ~replace_na(.,0))
 return(dataset)
}

right <- pitcher_ideal_creation(right)
left <- pitcher_ideal_creation(left)
```


### Creating Right Handed Models 

#### Curveball

```{r}
right_curve <- right %>% filter(pitch_type == "CU")
right_curve <- right_curve %>% group_by(player_name) %>% 
  mutate(mean_centered_spinrate = mean(release_spin_rate) - release_spin_rate) %>% 
  ungroup()

rh_cu_model <- glmer(pitcher_ideal ~ release_speed + hor_break + 
                       ind_vert_break + mean_centered_spinrate + (1|player_name),
                   family = "binomial", data = right_curve)


tidy(rh_cu_model) %>% kable(digits = 4)
```

```{r}
rh_cu_model_final <- glmer(pitcher_ideal ~
                       hor_break + mean_centered_spinrate + (1|player_name), 
                     family = "binomial", data = right_curve)
tidy(rh_cu_model_final) %>% kable(digits = 4)
```


```{r}
right_curve <- right_curve %>% 
  mutate(ideal_prob = (exp(0.0310 + 0.0120*hor_break + 0.0005*mean_centered_spinrate)
                       / (1+exp(0.0310 + 0.0120*hor_break + 0.0005*mean_centered_spinrate))))

right_curve <- right_curve %>% 
  mutate(pitch_rating = 100 * (ideal_prob/mean(ideal_prob)))
```


#### Knuckle-Curve

```{r}
right_knuckle_curve <- right %>% filter(pitch_type == "KC")
right_knuckle_curve <- right_knuckle_curve %>% group_by(player_name) %>% 
  mutate(mean_centered_spinrate = mean(release_spin_rate) - release_spin_rate) %>% 
  ungroup()

rh_kc_model <- glmer(pitcher_ideal ~ release_speed + hor_break + 
                       ind_vert_break + mean_centered_spinrate + (1|player_name),
                   family = "binomial", data = right_knuckle_curve)


tidy(rh_kc_model) %>% kable(digits = 4)
```


#### Slider 

```{r}
right_slider <- right %>% filter(pitch_type == "SL")
right_slider <- right_slider %>% group_by(player_name) %>% 
  mutate(mean_centered_spinrate = mean(release_spin_rate) - release_spin_rate) %>% 
  ungroup()

rh_sl_model <- glmer(pitcher_ideal ~ release_speed + hor_break + 
                       ind_vert_break + mean_centered_spinrate + (1|player_name),
                   family = "binomial", data = right_slider)


tidy(rh_sl_model) %>% kable(digits = 4)
```


```{r}
rh_sl_model_final <- glmer(pitcher_ideal ~
                       release_speed + ind_vert_break + mean_centered_spinrate +
                         (1|player_name), 
                     family = "binomial", data = right_slider)
tidy(rh_sl_model_final) %>% kable(digits = 4)
```


```{r}
right_slider <- right_slider %>% 
  mutate(ideal_prob = (exp(1.1590 + -0.0110*release_speed + ind_vert_break*0.0054 
                           + 0.0003*mean_centered_spinrate)
                       / (1+exp(1.1590 + -0.0110*release_speed + ind_vert_break*0.0054 
                           + 0.0003*mean_centered_spinrate))))

right_slider <- right_slider %>% 
  mutate(pitch_rating = 100 * (ideal_prob/mean(ideal_prob)))
```



### Creating Left Handed Models 

#### Curve

```{r}
left_curve <- left %>% filter(pitch_type == "CU")
left_curve <- left_curve %>% group_by(player_name) %>% 
  mutate(mean_centered_spinrate = mean(release_spin_rate) - release_spin_rate) %>% 
  ungroup()

lh_cu_model <- glmer(pitcher_ideal ~ release_speed + hor_break + 
                       ind_vert_break + mean_centered_spinrate + (1|player_name),
                   family = "binomial", data = left_curve)


tidy(lh_cu_model) %>% kable(digits = 4)
```


```{r}
lh_cu_model_final <- glmer(pitcher_ideal ~
                       hor_break + mean_centered_spinrate + (1|player_name), 
                     family = "binomial", data = left_curve)
tidy(lh_cu_model_final) %>% kable(digits = 4)
```


```{r}
left_curve <- left_curve %>% 
  mutate(ideal_prob = (exp(0.1254 + -0.0074*hor_break + 0.0004*mean_centered_spinrate)
                       / (1+exp(0.1254 + -0.0074*hor_break + 0.0004*mean_centered_spinrate))))

left_curve <- left_curve %>% 
  mutate(pitch_rating = 100 * (ideal_prob/mean(ideal_prob)))
```


#### Knuckle-Curve

```{r}
left_knuckle_curve <- left %>% filter(pitch_type == "KC")
left_knuckle_curve <- left_knuckle_curve %>% group_by(player_name) %>% 
  mutate(mean_centered_spinrate = mean(release_spin_rate) - release_spin_rate) %>% 
  ungroup()

lh_kc_model <- glmer(pitcher_ideal ~ release_speed + hor_break + 
                       ind_vert_break + mean_centered_spinrate + (1|player_name),
                   family = "binomial", data = left_knuckle_curve)


tidy(rh_kc_model) %>% kable(digits = 4)
```



#### Slider 

```{r}
left_slider <- left %>% filter(pitch_type == "SL")
left_slider <- left_slider %>% group_by(player_name) %>% 
  mutate(mean_centered_spinrate = mean(release_spin_rate) - release_spin_rate) %>% 
  ungroup()

lh_sl_model <- glmer(pitcher_ideal ~ release_speed + hor_break + 
                       ind_vert_break + mean_centered_spinrate + (1|player_name),
                   family = "binomial", data = left_slider)


tidy(lh_sl_model) %>% kable(digits = 4)
```

```{r}
lh_sl_model_final <- glmer(pitcher_ideal ~
                       hor_break + ind_vert_break + mean_centered_spinrate +
                         (1|player_name), 
                     family = "binomial", data = left_slider)
tidy(lh_sl_model_final) %>% kable(digits = 4)
```


```{r}
left_slider <- left_slider %>% 
  mutate(ideal_prob = (exp(0.1821 + -0.0066*hor_break + ind_vert_break*0.0150 
                           + 0.0002*mean_centered_spinrate)
                       / (1+exp(0.1821 + -0.0066*hor_break + ind_vert_break*0.0150 
                           + 0.0002*mean_centered_spinrate))))

left_slider <- left_slider %>% 
  mutate(pitch_rating = 100 * (ideal_prob/mean(ideal_prob)))
```






## Appendix 

```{r}
right_names = right %>% group_by(player_name) %>%  .$player_name
left_names = left %>% group_by(player_name) %>%  .$player_name
set.seed(3)

# get sample of 12 pitchers
sample_righties <- sample(right_names, 12)
sample_lefties <- sample(left_names, 12)

# get data for those schools
sample_data_r <- right %>%
  filter(player_name %in% sample_righties)

sample_data_l <- left %>% 
  filter(player_name %in% sample_lefties)

ggplot(data = sample_data_r, mapping = aes(x=release_extension, y=release_speed, 
                                color = pitch_name)) + facet_wrap(~player_name) +
  geom_point() + 
  labs(title = "Inconclusive Evidence of Righty Extension/Speed Relationship", 
       x = "Release Extension (Feet)", 
       y = "Release Speed (MPH)")



```


```{r}
ggplot(data = sample_data_l, mapping = aes(x=release_extension, y=release_speed, 
                                color = pitch_name)) + facet_wrap(~player_name) +
  geom_point() + 
  labs(title = "Inconclusive Evidence of 
       Lefty Extension/Speed Relationship", 
       x = "Release Extension (Feet)", 
       y = "Release Speed (MPH)")
```
